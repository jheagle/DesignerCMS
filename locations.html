<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    <title>Title</title>
    <link rel="stylesheet" href="css/style.css"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script>
      window.jQuery || document.write('<script src="js/vendor/jquery-2.4.1.min.js"><\/script>')
    </script>
    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
    <script src="js/vendor/oms.min.js"></script>
</head>
<body onload="load()">
<div class="container">
    <div class="spacing">
        <h3 class="search-title">Search Locations</h3>
    </div>
    <div class="search-controls">
        <img src="../search.png"/>
        <input type="text" id="addressInput" placeholder="Address"/>
        <select id="radiusSelect">
            <option value="10" selected="selected">10km</option>
            <option value="20">20km</option>
            <option value="80">80km</option>
            <option value="200">200km</option>
            <option value="400">400km</option>
        </select>
        <input type="text" id="Location" placeholder="Location Name"/>
        <input type="hidden" id="product" value="other"/>
        <input type="button" onclick="searchLocations()" value="Search"/>
    </div>
    <div class="map-locations">
        <div class="locations">
            <div id="locationSelect"></div>
        </div>
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
</div>
<script type="text/javascript">
  //<![CDATA[
  var map, markers = [], infoWindow, locationSelect, oms, usualColor = 'ffffff', spiderfiedColor = 'ddd9c9',
    shadow = new google.maps.MarkerImage('https://www.google.com/intl/en_ALL/mapfiles/shadow50.png', new google.maps.Size(37, 34), new google.maps.Point(0, 0), new google.maps.Point(10, 34)),
    product = document.getElementById('product').value

  function iconWithColor (color) {
    //return 'http://chart.googleapis.com/chart?chst=d_map_xpin_letter&chld=pin|+|' + color + '|000000|ffffff';
    return '../bright-optical.png'
  }

  function load () {
    map = new google.maps.Map(document.getElementById('map'), {
      center: new google.maps.LatLng(61, -97),
      zoom: 4,
      mapTypeId: 'roadmap',
      mapTypeControlOptions: {
        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
      }
    })
    infoWindow = new google.maps.InfoWindow()
    oms = new OverlappingMarkerSpiderfier(map, {
      markersWontMove: true,
      markersWontHide: true
    })
    locationSelect = document.getElementById('locationSelect')
    loadMarkers()
  }

  function loadMarkers () {
    var radius = document.getElementById('radiusSelect').value
    var searchUrl = 'resources/generatejson.php?product=' + product

    $.getJSON(searchUrl, function (data) {
      var bounds = new google.maps.LatLngBounds()
      var options = ''
      $.each(data, function (i, location) {
        var latlng = new google.maps.LatLng(parseFloat(location.lat), parseFloat(location.lng))

        options = createOption(location, options)
        createMarker(latlng, location)
        bounds.extend(latlng)
      })
      $('#locationSelect').html(options)
      map.fitBounds(bounds)
      $('.option').click(function () {
        $('.selected-option').removeClass('selected-option')
        $(this).addClass('selected-option')
        var markerNum = $(this).index()
        if (markerNum != 'none') {
          google.maps.event.trigger(markers[markerNum], 'click')
          google.maps.event.trigger(markers[markerNum], 'click')
        }
      })
    })

    oms.addListener('click', function (marker) {
      infoWindow.setContent(marker.desc)
      infoWindow.open(map, marker)
    })

    oms.addListener('spiderfy', function (markers) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setIcon(iconWithColor(spiderfiedColor))
        markers[i].setShadow(null)
      }
      infoWindow.close()
    })

    oms.addListener('unspiderfy', function (markers) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setIcon(iconWithColor(usualColor))
        markers[i].setShadow(shadow)
      }
    })
  }

  function searchLocations () {
    var location = document.getElementById('location').value, address = document.getElementById('addressInput').value
    if (address != '') {
      var geocoder = new google.maps.Geocoder()
      geocoder.geocode({
        address: address
      }, function (results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          searchWithAddress(results[0].geometry.location, location)
        }
        else {
          alert(address + ' not found')
        }
      })
    }
    else if (location != '') {
      searchLocationsNear('../generatejson.php?location=' + location + '&product=' + product)
    }
  }

  function clearLocations () {
    infoWindow.close()
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(null)
    }
    markers.length = 0

    locationSelect.innerHTML = ''
    var option = document.createElement('option')
    option.value = 'none'
    option.innerHTML = '<p>There are no Locations<br>that match this criteria.</p>'
    locationSelect.appendChild(option)
  }

  function searchWithAddress (center, location) {
    var radius = document.getElementById('radiusSelect').value
    if (location != '') {
      searchLocationsNear('../generatejson.php?lat=' + center.lat() + '&lng=' + center.lng() + '&radius=' + radius + '&location=' + location + '&product=' + product)
    }
    else {
      searchLocationsNear('../generatejson.php?lat=' + center.lat() + '&lng=' + center.lng() + '&radius=' + radius + '&product=' + product)
    }
  }

  function searchLocationsNear (searchUrl) {
    clearLocations()

    $.getJSON(searchUrl, function (data) {
      var bounds = new google.maps.LatLngBounds()
      var options = ''
      if (data.length > 0) {
        $.each(data, function (i, marker) {
          var latlng = new google.maps.LatLng(parseFloat(marker.lat), parseFloat(marker.lng))

          options = createOption(marker, options)
          createMarker(latlng, marker)
          bounds.extend(latlng)
        })
        $('#locationSelect').html(options)
        map.fitBounds(bounds)
        $('.option').click(function () {
          $('.selected-option').removeClass('selected-option')
          $(this).addClass('selected-option')
          var markerNum = $(this).index()
          if (markerNum != 'none') {
            google.maps.event.trigger(markers[markerNum], 'click')
            google.maps.event.trigger(markers[markerNum], 'click')
          }
        })
      }
    })

    oms.addListener('click', function (marker) {
      infoWindow.setContent(marker.desc)
      infoWindow.open(map, marker)
    })

    oms.addListener('spiderfy', function (markers) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setIcon(iconWithColor(spiderfiedColor))
        markers[i].setShadow(null)
      }
      infoWindow.close()
    })

    oms.addListener('unspiderfy', function (markers) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setIcon(iconWithColor(usualColor))
        markers[i].setShadow(shadow)
      }
    })
  }

  function createMarker (latlng, location) {
    var s = ''
    if (location.tel.length > 10) {
      var x = location.tel.length - 4
      var front = x % 3
      if (front > 0) {
        x -= front
        s = location.tel.substr(location.tel.length * -1, front) + ' ('
      }
      else {
        s = '('
      }
      for (var j = x; j > 0; j -= 3) {
        var y = (j + 4) * -1
        s += location.tel.substr(y, 3)
        if (j === x) {
          s += ') '
        }
        else {
          s += '-'
        }
      }
      s += location.tel.substr(-4, 4)
    }
    else if (location.tel.length > 7) {
      s = '(' + location.tel.substr(0, 3) + ') ' + location.tel.substr(3, 3) + '-' + location.tel.substr(6, 4)
    }
    else {
      s = location.tel.substr(0, 3) + '-' + location.tel.substr(3, 4)
    }
    var html = '<div class="info-window"><h3>' + location.name + '</h3><h4>' + location.contact + '</h4><p>' + location.address + '<br><a href="tel:' + location.tel + '">' + (typeof (location.tel) === 'undefined' ? location.tel : s) + '</a><br><a href="' + location.link + '" target="_blank">' + location.link + '</a><br>' + location.info + '</p></div>'
    var marker = new google.maps.Marker({
      map: map,
      position: latlng,
      title: location.name,
      icon: iconWithColor(usualColor),
      shadow: shadow
    })

    marker.desc = html

    markers.push(marker)
    oms.addMarker(marker)
  }

  function createOption (location, options) {
    var s = ''
    if (location.tel.length > 10) {
      var x = location.tel.length - 4
      var front = x % 3
      if (front > 0) {
        x -= front
        s = location.tel.substr(location.tel.length * -1, front) + ' ('
      }
      else {
        s = '('
      }
      for (var j = x; j > 0; j -= 3) {
        var y = (j + 4) * -1
        s += location.tel.substr(y, 3)
        if (j === x) {
          s += ') '
        }
        else {
          s += '-'
        }
      }
      s += location.tel.substr(-4, 4)
    }
    else if (location.tel.length > 7) {
      s = '(' + location.tel.substr(0, 3) + ') ' + location.tel.substr(3, 3) + '-' + location.tel.substr(6, 4)
    }
    else {
      s = location.tel.substr(0, 3) + '-' + location.tel.substr(3, 4)
    }

    if (typeof (location.distance) === 'undefined') {
      options += '<div class="option" id="' + location.id + '"><h3>' + location.name + '</h3><h4>' + location.contact + '</h4><p>' + location.address + '<br><a href="tel:' + location.tel + '">' + (typeof (location.tel) === 'undefined' ? location.tel : s) + '</a><br><a href="' + location.link + '" target="_blank">' + location.link + '</a><br>' + location.info + '</p></div>'
    }
    else {
      options += '<div class="option" id="' + location.id + '"><h3>(' + parseFloat(location.distance).toFixed(2) + 'km) ' + location.name + '</h3><h4>' + location.contact + '</h4><p>' + location.address + '<br><a href="tel:' + location.tel + '">' + (typeof (location.tel) === 'undefined' ? location.tel : s) + '</a><br><a href="' + location.link + '">' + location.link + '</a><br>' + location.info + '</p></div>'
    }

    return options
  }

  //]]>
</script>
</body>
</html>