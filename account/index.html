<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width">
    <title>Administer Account</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script>
      window.jQuery || document.write('<script src="js/vendor/jquery-2.4.1.min.js"><\/script>')
    </script>
    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
</head>
<body>
<div class="container-admin">
    <div class="top-bar">
        <ul class="menu">
            <li>
                <a href="../locations.html" target="_blank">Find a Location</a>
            </li>
            <li>
                <a href="../locations.html" target="_blank">Find a Location</a>
            </li>
            <li>
                <a href="../admin/" class="no-click">Administer</a>
            </li>
            <li>
                <a href="index.html" class="no-click">Accounts</a>
            </li>
            <li>
                <a href="../controllers/login.php">Log Out</a>
            </li>
        </ul>
    </div>
    <form class="form" action="../controllers/account.php" method="post" onsubmit="return validateAccount()">
        <select id="accounts" size="35"></select>
        <div class="input-form">
            <div>
                <div>
                    <label for="id">ID: </label>
                    <input id="id" name="id" type="number" placeholder="ID" disabled="disabled">
                </div>
                <div>
                    <label for="username">Username: </label>
                    <input id="username" name="username" type="text" placeholder="Username">
                </div>
                <div>
                    <label for="type">Type: </label>
                    <select id="type" name="type" disabled="disabled">
                        <option value="1" selected="selected">User</option>
                        <option value="0">Administrator</option>
                    </select>
                </div>
            </div>
            <div>
                <div>
                    <label for="password">New Password: </label>
                    <input id="password" name="password" type="password" placeholder="New Password">
                </div>
                <div>
                    <label for="confirm">Confirm Password: </label>
                    <input id="confirm" name="confirm" type="password" placeholder="Confirm Password">
                </div>
            </div>
            <div>
                <div>
                    <input id="clear" name="clear" type="button" onclick="clearAll()" value="Clear All"
                           disabled="disabled">
                </div>
            </div>
            <div class="submit">
                <div>
                    <input id="create" name="create" type="submit" onclick="return verifyCreate()"
                           value="Create / Update">
                </div>
                <div>
                    <input id="delete" name="delete" type="submit" onclick="return verifyDelete()" value="Delete">
                </div>
            </div>
        </div>
    </form>
</div>
<script>
  var accounts = $()
  window.onload = function () {
    var options = ''
    $('#id').attr('disabled', 'disabled')
    $('#type').attr('disabled', 'disabled')
    $('#clear').attr('disabled', 'disabled')

    $.getJSON('../controllers/account.php', function (data) {
      accounts = data
      $.each(data, function (j, account) {
        if (data.length - 1 != j || j === 0) {
          options += '<option value="' + account.id + '">' + account.username + '</option>'
        }
      })
      $('#accounts').html(options)
      $('.no-click').removeClass('no-click')
      $('#create').removeAttr('disabled')
      $('#delete').removeAttr('disabled')

      if (accounts.length > 1) {
        $('#type').removeAttr('disabled')
        $('#clear').removeAttr('disabled')
      }
      else {
        $('#accounts').val($('#accounts option:first').val())
        var id = $('#accounts option:selected').val()
        var account = retrieveAccount(id)
        setAccount(account)
      }
    }).fail(function () {
      window.location.replace('../login.html')
    })

    $('#accounts').change(function () {
      var id = $('#accounts option:selected').val()
      var account = retrieveAccount(id)
      setAccount(account)
    })

    function retrieveAccount (id) {
      var account = $()
      $.each(accounts, function (j, acc) {
        if (acc.id === id) {
          account = acc
          return account
        }
      })

      return account
    }

    function setAccount (account) {
      $('#id').val(account.id)
      $('#username').val(account.username)
      $('#type').val(account.type)
    }

  }

  // close onload

  function verifyCreate () {
    if ($('#id').val() === '') {

      if ($('#password').val() === '') {
        alert('Password is Required')
      }
      else if ($('#confirm').val() === '') {
        alert('Please confirm password')
      }
      else if ($('#password').val() != $('#confirm').val()) {
        alert('Please ensure the password and password confirmation match.')
      }
      else {
        var duplicate = false, acc = $()
        $.each(accounts, function (i, account) {
          if ($('#username').val() === account.username) {
            acc = account
            duplicate = true
            return false
          }
        })

        if (duplicate) {
          alert('ERROR: This username is already in use, please choose another username.')
          return false
        }
        return true
      }
      return false
    }
    return confirm('Are you sure you want to modify this account?')
  }

  function verifyDelete () {
    return confirm('Are you sure you want to delete this account?\nIf this is your account, you will be logged out.')
  }

  function clearAll () {
    $('#id').val('')
    $('#username').val('')
    $('#type').val(1)
    $('#password').val('')
    $('#confirm').val('')
    $('#accounts').val([])
  }

  function validateAccount () {
    $('#clear').attr('disabled', 'disabled')
    $('#create').attr('disabled', 'disabled')
    $('#delete').attr('disabled', 'disabled')
    if ($('#username').val() === '') {
      alert('Userame is Required')
    }
    else {
      if ($('#password').val() != $('#confirm').val()) {
        $('#password').val('')
        $('#confirm').val('')
      }
      $('#id').removeAttr('disabled')
      $('#type').removeAttr('disabled')

      if (accounts.length > 1) {
        $('#clear').removeAttr('disabled')
      }
      $('#create').removeAttr('disabled')
      $('#delete').removeAttr('disabled')
      return true
    }

    if (accounts.length > 1) {
      $('#clear').removeAttr('disabled')
    }
    $('#create').removeAttr('disabled')
    $('#delete').removeAttr('disabled')
    return false
  }
</script>
</body>
</html>